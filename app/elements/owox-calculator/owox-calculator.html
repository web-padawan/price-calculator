<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="owox-calculator">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        width: 862px;
        margin: 5% auto;
        padding: 0 50px;
        background: #fff;
        max-height: 602px;
        height: 602px;
        overflow-y: auto;
      }

      .owox-calculator-heading {
        font: normal 600 2.5em 'OpenSansSemibold', sans-serif;
        color: #333;
        margin: 0 0 5px;
      }

      .owox-calculator-l {
        width: 395px;
        float: left;
        margin: 12px 0 0 22px;
        padding-left: 0;
        list-style: none;
      }

      .owox-calculator-l-i {
        padding: 0 0 26px 19px;
        color: #444;
        border-left: 1px solid #cfcfcf;
      }

      .owox-calculator-l-i:nth-of-type(3) {
        border-left: none;
      }

      .owox-calculator-l-i-heading {
        font-size: 1.26em;
        margin: 0 0 15px;
        position: relative;
      }

      .owox-calculator-l-i-heading:before {
        position: absolute;
        top: 0;
        left: -49px;
        width: 32px;
        height: 32px;
        background: #0088cc;
        color: #fff;
        line-height: 1.8em;
        text-align: center;
        border-radius: 50%;
      }

      .owox-calculator-l-i:nth-of-type(1) .owox-calculator-l-i-heading:before {
        content: '1';
      }
      .owox-calculator-l-i:nth-of-type(2) .owox-calculator-l-i-heading:before {
        content: '2';
      }
      .owox-calculator-l-i:nth-of-type(3) .owox-calculator-l-i-heading:before {
        content: '3';
        left: -46px;
      }

      .owox-calculator-l-i-select-btn {
        display: inline-block;
        position: relative;
        width: 158px;
        padding: 12px 0;
        margin: 0 12px 0 0;
        text-align: center;
        font-size: 1.06em;
        border: 1px solid #e1e1e1;
        cursor: pointer;
        transition: all 0.3s;
      }

      .owox-calculator-l-i-select-btn.iron-selected {
        border: 1px solid #8db5f8;
        box-shadow: 0 2px 7px rgba(51,51,51,0.2);
      }

      .owox-calculator-l-i-heading {
        font-size: 1.26em;
        margin: 0 0 15px;
        position: relative;
      }

      .owox-calculator-l-i-input-t {
        margin: 7px 0 0;
        padding: 1px 0;
        width: 160px;
        border: 1px solid #e1e1e1;
        color: #333;
        font: normal 400 2.267em 'OpenSansRegular', sans-serif;
      }

      .owox-calculator-right {
        float: right;
        margin-right: 50px;
      }

      .owox-calculator-copy-container {
          position: relative;
          margin: 0 0 10px;
      }

      .owox-calculator-copy-link-btn {
        padding-left: 28px;
      }

      .owox-calculator-copy-link-btn:before {
        content: '';
        display: inline-block;
        position: absolute;
        top: 4px;
        left: 0;
        width: 25px;
        height: 15px;
        background: url(https://i.owox.com/owox_com/link-icon.png) no-repeat 0 0;
      }

      .owox-calculator-copy-link-btn-t {
        display: inline-block;
        border-bottom: 1px dashed #5c5c5c;
        cursor: pointer;
        position: relative;
      }

      .owox-calculator-copy-result {
        position: absolute;
        z-index: 21;
        right: 0;
        top: 40px;
        right: 20px;
        padding: 15px;
        background: #fff;
        border: 1px solid #8db5f8;
        border-radius: 4px;
      }

      .owox-calculator-copy-result:before {
        content: '';
        display: inline-block;
        width: 12px;
        height: 16px;
        background: url(https://i.owox.com/owox_com/calculator-corner.png) no-repeat 0 0;
        position: absolute;
        left: 50%;
        top: -12px;
        transform: rotate(90deg);
      }

      .owox-calculator-copy-url-box {
        width: 400px;
        font-size: 0.84em;
        border: none;
        color: #646464;
      }

      .owox-calculator-copy-success {
        margin: 10px 0 0;
        padding: 0 0 0 25px;
        position: relative;
      }

      .owox-calculator-copy-success:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 0;
        display: inline-block;
        width: 16px;
        height: 16px;
        background: url(https://i.owox.com/owox_com/checked-list-small.png) no-repeat 0 0;
      }

      .owox-calculator-summary {
        width: 276px;
        padding: 10px 25px 10px;
        background-color: #f5f7f8;
        box-shadow: 0 1px 1px rgba(0,0,0,0.2);
        border-radius: 3px;
      }

      .owox-calculator-summary-heading {
        margin: 0 0 16px;
        font: normal 300 1.73em 'OpenSansLight', sans-serif;
        color: #646464;
      }

      .owox-calculator-summary-calc {
        margin: 12px 0;
        overflow: hidden;
      }

      .owox-calculator-summary-calc-title,
      .owox-calculator-summary-calc-amount {
        font-size: 1.1em;
      }

      .owox-calculator-summary-calc-title {
        float: left;
        width: 140px
      }

      .owox-calculator-summary-calc-amount {
        width: 80px;
        float: right;
        text-align: right;
      }

      .owox-calculator-total {
        max-height: 246px;
        margin: 2px 0;
        padding: 5px 10px;
        background-color: #eef2f5;
        text-align: center;
        box-shadow: 0 1px 1px rgba(0,0,0,0.2);
      }

      .owox-calculator-total-heading {
        margin: 0 0 10px;
        font: normal 300 1.73em 'OpenSansLight', sans-serif;
        text-align: center;
      }

      .owox-calculator-total-amount {
        margin:0 0 20px;
        height:64px;
        overflow-y: hidden;
        font: normal 300 3.3em 'OpenSansLight', sans-serif;
      }

      .owox-calculator-total-btn {
        display: inline-block;
        padding: 14px 71px;
        font-size: 1.2em;
        color: #fff;
        background-color: #d94836;
        border-radius: 3px;
        text-decoration: none;
      }

      .owox-calculator-total-btn:hover {
        background-color: #C74130;
        color: #fff;
      }

      .owox-calculator-total-advise {
        max-width: 200px;
        padding: 5px 0 20px;
        margin: 0 auto;
      }

      .owox-calculator-annotation {
        width: 210px;
        margin: 10px auto 0;
        font-size: 0.8em;
        text-align: center;
      }

      .owox-calculator-annotation-l-grey {
        color: #646464;
      }

      .owox-calculator-estimate {
        margin: 0 -50px;
      }

      .owox-calculator-estimate input {
        display: none;
      }

      .owox-calculator-estimate-btn {
        padding: 13px 13px 13px 96px;
        position: relative;
        z-index: 20;
        display: inline-block;
        cursor: pointer;
        color: #1582b0;
      }

      .owox-calculator-estimate label:before {
        content: '\25B6';
        transition: all 0.3s;
      }

      .owox-calculator-estimate-btn-t {
        margin-left: 5px;
        border-bottom: 1px dashed #1582b0;
      }

      .owox-calculator-estimate input:checked + label:before {
        content: '\25BC';
        transform: rotate(90deg);
      }

      .owox-calculator-estimate-content-block {
        padding: 20px 50px 50px 100px;
      }

      .owox-pricing-popup-estimate-content-block-heading {
        margin: 0 0 15px;
        font-size: 1.1em;
      }

    </style>

    <h2 class="owox-calculator-heading">Calculate Your Price</h2>

    <!-- left panel -->
    <ul class="owox-calculator-l">
      <li class="owox-calculator-l-i">
        <fieldset>
          <legend class="owox-calculator-l-i-heading">Select plan</legend>
          <iron-selector id="plan" class="owox-calculator-l-i-select" attr-for-selected="name" selected="{{plan}}">
            <div name="pro" class="owox-calculator-l-i-select-btn">Pro</div>
            <div name="enterprise" class="owox-calculator-l-i-select-btn">Enterprise</div>
          </iron-selector>
        </fieldset>
      </li>
      <li class="owox-calculator-l-i">
        <fieldset>
          <legend class="owox-calculator-l-i-heading">Payment contract</legend>
          <iron-selector id="payment" class="owox-calculator-l-i-select" attr-for-selected="name" selected="{{payment}}">
            <div name="monthly" class="owox-calculator-l-i-select-btn">Monthly</div>
          </iron-selector>
        </fieldset>
      </li>
      <li class="owox-calculator-l-i">
        <fieldset>
          <legend class="owox-calculator-l-i-heading">Number of unique users per month</legend>
          <input id="users" class="owox-calculator-l-i-input-t" type="text" value="{{users::input}}">
        </fieldset>
      </li>
    </ul>
    <!-- end left panel -->

    <!-- right panel -->
    <div class="owox-calculator-right">
      <div class="owox-calculator-copy-container">
        <div class="owox-calculator-copy-link-btn">
          <span id="copy" class="owox-calculator-copy-link-btn-t">Copy url to clipboard</span>
        </div>
        <div id="tooltip" class="owox-calculator-copy-result hidden">
          <input id="url_container" class="owox-calculator-copy-url-box" readonly>
          <div id="message" class="owox-calculator-copy-success">Copied to clipboard!</div>
        </div>
      </div>

      <div class="owox-calculator-summary">
        <h4 class="owox-calculator-summary-heading">Pricing Summary</h4>
        <div class="owox-calculator-summary-calc">
          <div class="owox-calculator-summary-calc-title">{{formatPlanTitle(plan)}}</div>
          <div class="owox-calculator-summary-calc-amount">{{formatPlanAmount(plan)}}</div>
        </div>
        <div class="owox-calculator-summary-calc">
          <div class="owox-calculator-summary-calc-title">Users:</div>
          <div class="owox-calculator-summary-calc-amount">{{formatUsersAmount(plan, users)}}</div>
        </div>
      </div>

      <div class="owox-calculator-total">
        <h4 class="owox-calculator-total-heading">Total per month:</h4>
        <div id="total" class="owox-calculator-total-amount">{{formatTotalAmount(total)}}</div>
        <a href="https://my.bi.owox.com/ui/projects/setup/?type={{plan}}" class="owox-calculator-total-btn">Start</a>
        <div class="owox-calculator-total-advise">Sign in with your Google account</div>
      </div>

      <div class="owox-calculator-annotation">
        You pay for Google Cloud Platform usage separately according
        to&nbsp;<a href="https://cloud.google.com/bigquery/pricing#storage" target="_blank" class="owox-calculator-annotation-l-grey">pricing.</a>
      </div>
    </div>
    <!-- end right panel -->

    <div class="clearfix"></div>

    <!-- bottom block -->
    <div class="owox-calculator-estimate">
      <input id="expand" type="checkbox">
      <label for="expand" class="owox-calculator-estimate-btn">
        <span class="owox-calculator-estimate-btn-t">How to estimate active users?</span>
      </label>
      <div id="estimate_content" class="owox-calculator-estimate-content hidden">
        <div class="owox-calculator-estimate-content-block">
          <h4 class="owox-calculator-estimate-content-block-heading">
            1. Select the <b>Reporting</b> tab.
          </h4>
          <img src="https://i.owox.com/owox_com/calc-img1.jpg" alt="">
        </div>
        <div class="owox-calculator-estimate-content-block">
          <h4 class="owox-calculator-estimate-content-block-heading">
            2. Select <b>Audience &gt; Overview</b> from the Report navigation.
          </h4>
          <img src="https://i.owox.com/owox_com/calc-img2.jpg" alt="">
        </div>
        <div class="owox-calculator-estimate-content-block">
          <h4 class="owox-calculator-estimate-content-block-heading">
            3. The number of active users for the past 30 days is available below the chart.
          </h4>
          <img src="https://i.owox.com/owox_com/calc-img3.jpg" alt="">
        </div>
      </div>
    </div>
    <!-- end bottom block -->
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'owox-calculator',

        listeners: {
          'click'               : '_hideMessage',
          'users.input'         : '_inputUsers',
          'plan.iron-deselect'  : '_selectPlan',
          'copy.click'          : '_copyUrl',
          'expand.click'        : '_expandEstimate'
        },

        properties: {
          plan: {
            type: String,
            value: 'pro',
            notify: true
          },
          payment: {
            type: String,
            value: 'monthly',
            notify: true
          },
          total: {
            type: Number,
            computed: 'computeTotal(plan, users)',
            notify: true
          },
          users: {
            type: String,
            value: '1,000,000',
            notify: true,
            observer: '_observeUsers'
          }
        },

        // add commas while user typing numbers; update url parameters
        _inputUsers: function(e) {
          var users = e.target.value.replace(/\D/g, "");
          e.target.value = users.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          page('?plan=' + this.plan + ';payment=' + this.payment + ';users=' + users);
        },

        // observe for users change
        _observeUsers: function() {
          this.$.users.value = this.$.users.value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },

        // update url parameters
        _selectPlan: function(e) {
          page(this.makeUrlParams());
        },

        // copy url to clipboard
        _copyUrl: function(e) {
          e.stopPropagation();

          this.$.url_container.value = window.location.origin + '/' + this.makeUrlParams();
          this.toggleClass('hidden', false, this.$.tooltip);
          this.$.url_container.select();

          try {
            if (document.execCommand('copy')) {
              this.$.message.textCnotent = 'Copied to clipboard!';
            }
          } catch (err) {
            this.$.message.textCnotent = 'Please press Ctrl-C to copy link';
          }
        },

        // hide message
        _hideMessage: function(e) {
          if (e.target.id !== 'tooltip' && e.target.parentNode.id !== 'tooltip') {
            this.toggleClass('hidden', true, this.$.tooltip);
          }
        },

        // expand and collapse estimate
        _expandEstimate: function(e) {
          if (Array.prototype.slice.call(this.$.estimate_content.classList).indexOf('hidden') === -1) {
            this.toggleClass('hidden', true, this.$.estimate_content);
          }
          else {
            this.toggleClass('hidden', false, this.$.estimate_content);

            var self = this, t = 0;
            var timer = setTimeout(function tick() {
              if (self.scrollTop > 480) return;
              self.scrollTop = self.scrollTop + 25 * t;
              t += 1;
              timer = setTimeout(tick, 25);
            }, 25);
          }
        },

        // calculate total amount
        computeTotal: function(plan, users) {
          var count = Number(users.replace(/\D/g, ""));
          switch (plan) {
            case 'pro':
              return Math.ceil(count * 0.96 / 1000 + 95);
              break;
            case 'enterprise':
              return Math.ceil(count * 0.85 / 1000 + 1200);
              break;
          }
        },

        // output formatted plan title
        formatPlanTitle: function(plan) {
          return plan.charAt(0).toUpperCase() + plan.slice(1) + ' Plan:';
        },

        // output formatted plan amount
        formatPlanAmount: function(plan) {
          return (plan === 'pro') ? '$ 95' : '$ 1,200';
        },

        // output formatted total amount
        formatTotalAmount: function(total) {
          return '$ ' + total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        },

        // output formatted users amount
        formatUsersAmount: function(plan, users) {
          var count = Number(users.replace(/\D/g, ""));
          switch (plan) {
            case 'pro':
              return '$ ' + Math.ceil(count * 0.96 / 1000);
              break;
            case 'enterprise':
              return '$ ' + Math.ceil(count * 0.85 / 1000);
              break;
          }
        },

        // make url parameters helper
        makeUrlParams: function() {
          return '?plan=' + this.plan + ';payment=' + this.payment + ';users=' + this.users.replace(/\D/g, "");
        }
      });
    })();
  </script>
</dom-module>
